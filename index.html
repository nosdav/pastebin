<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/style.css" />
    <title>NosDAV Pastebin</title>
    <script type="application/ld+json" id="data">
      {
        "@context": "https://schema.org"
      }
    </script>

    <script type="module">
      import { html, render, Component } from './js/spux.js'
      import './js/dior.js'

      const serverUrl = 'https://nosdav.nostr.rocks'
      var userHex, filename, contentType, path
      var isJson = false

      function getQueryStringValue(key) {
        const queryString = window.location.search.substring(1)
        const queryParams = new URLSearchParams(queryString)
        return queryParams.get(key)
      }

      class App extends Component {
        constructor() {
          super()
          this.state = {
            userHex: null,
            filename: null,
            contentType: null,
            path: null,
            isJson: false
          }
          this.login = this.login.bind(this)
          this.save = this.save.bind(this)
        }

        async login() {
          userHex = await window.nostr.getPublicKey()
          console.log(`Logged in with public key: ${userHex}`)
          this.setState({ userHex: userHex })
          this.loadFile()
        }

        // Load the file content from the server
        loadFile() {
          if (!userHex) {
            alert('Please login first')
            return
          }

          var checkbox = document.getElementById('file-format')
          const fileContent = document.getElementById('file-content')

          if (checkbox.checked) {
            isJson = true
            filename = 'paste.json'
            path = `${serverUrl}/${userHex}/${filename}`
            document.getElementById('download').setAttribute('href', path)
            contentType = 'application/json'
          } else {
            isJson = false
            filename = 'paste.txt'
            path = `${serverUrl}/${userHex}/${filename}`
            contentType = 'text/plain'
            document.getElementById('download').setAttribute('href', path)
            contentType = 'application/json'
          }

          fetch(path, {
            headers: {
              Authorization: `Nostr ${userHex}`
            }
          })
            .then(response => {
              if (response.status === 200) {
                return response.text()
              } else {
                throw new Error('Failed to load file content')
              }
            })
            .then(text => {
              fileContent.value = text
              fileContent.placeholder = ''
            })
            .catch(error => {
              console.error(error)
              fileContent.placeholder = 'Error loading file content'
            })
        }

        save() {
          if (!userHex) {
            alert('Please login first')
            return
          }

          var checkbox = document.getElementById('file-format')
          const fileContent = document.getElementById('file-content')

          if (checkbox.checked) {
            isJson = true
            filename = 'paste.json'
            contentType = 'application/json'
          } else {
            isJson = false
            filename = 'paste.txt'
            contentType = 'text/plain'
          }

          const text = fileContent.value

          fetch(`${serverUrl}/${userHex}/${filename}`, {
            method: 'PUT',
            body: text,
            headers: {
              Authorization: `Nostr ${userHex}`,
              'Content-Type': contentType,
              'Content-Length': text.length
            }
          })
            .then(response => {
              if (response.status === 201) {
                console.log('File saved successfully')
              } else {
                throw new Error('Failed to save file')
              }
            })
            .catch(error => {
              console.error(error)
              alert('Error saving file')
            })
        }

        render() {
          const { userHex, filename, contentType, path, isJson } = this.state
          return html`
            <div id="container">
              <h1>NosDAV</h1>
              <label for="content"
                >Paste Text Below |
                <a href="#" id="download" target="_blank">Download</a></label
              >
              <textarea
                id="file-content"
                placeholder="Load..."
                name="content"
                rows="10"
              ></textarea>
              <label>
                <input
                  type="checkbox"
                  id="file-format"
                  name="file-format"
                  value="json"
                />
                use .json
              </label>
              <div>
                ${this.state.userHex
                  ? html`
                      <button id="save" onClick="${this.save}">Save</button>
                      <button id="login" onClick="${this.login}">Load</button>
                    `
                  : html` <button id="login" onClick="${this.login}">
                      Login
                    </button>`}
              </div>
              <div></div>
            </div>
          `
        }
      }

      render(html` <${App} /> `, document.body)
    </script>
  </head>
  <body></body>
</html>
