<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/style.css" />
    <title>NosDAV Pastebin</title>
    <script type="application/ld+json" id="data">
      {
        "@context": "https://schema.org"
      }
    </script>

    <script type="module">
      import { html, render, Component } from './js/spux.js'
      import './js/dior.js'
      import {
        getPath,
        getMimeType,
        isAbsoluteUrl,
        getQueryStringValue,
        generateAuthorizationHeader
      } from './util.js'

      const serverUrl =
        getQueryStringValue('storage') || 'https://nosdav.nostr.rocks'
      const mode = getQueryStringValue('mode') || 'm'
      var userPublicKey, filename, contentType, path

      class App extends Component {
        constructor() {
          super()
          const uri = getQueryStringValue('uri') || 'paste.txt'
          this.state = {
            userPublicKey: null,
            filename: null,
            contentType: null,
            path: null,
            slug: uri
          }
          this.userLogin = this.userLogin.bind(this)
          this.save = this.save.bind(this)
          this.updateSlug = this.updateSlug.bind(this)
        }

        updateDownloadLink() {
          const filename = document.getElementById('file-name').value
          const downloadLink = document.getElementById('download')
          const path = getPath(serverUrl, userPublicKey, filename, mode)
          downloadLink.setAttribute('href', path)
        }

        updateSlug(event) {
          this.setState({ slug: event.target.value })
        }

        async userLogin() {
          userPublicKey = await window.nostr.getPublicKey()
          console.log(`Logged in with public key: ${userPublicKey}`)
          this.setState({ userPublicKey: userPublicKey })
          this.loadFile()
        }

        // Load the file content from the server
        loadFile() {
          if (!userPublicKey) {
            alert('Please login first')
            return
          }

          const fileContent = document.getElementById('file-content')
          const inputSlug = document.getElementById('file-name').value

          filename = inputSlug

          path = getPath(serverUrl, userPublicKey, filename, mode)

          document.getElementById('download').setAttribute('href', path)
          contentType = getMimeType(filename)

          fetch(path, {
            headers: {
              Authorization: `Nostr ${userPublicKey}`
            }
          })
            .then(response => {
              if (response.status === 200) {
                return response.text()
              } else {
                throw new Error('Failed to load file content')
              }
            })
            .then(text => {
              fileContent.value = text
              fileContent.placeholder = ''
            })
            .catch(error => {
              console.error(error)
              fileContent.placeholder = 'Enter Text...'
            })

          this.updateDownloadLink()
        }

        async save() {
          if (!userPublicKey) {
            alert('Please login first')
            return
          }

          const fileContent = document.getElementById('file-content')
          const inputSlug = document.getElementById('file-name').value

          filename = inputSlug

          const text = fileContent.value

          let path = getPath(serverUrl, userPublicKey, filename, mode)
          contentType = getMimeType(filename)
          var authorization = await generateAuthorizationHeader(path)

          fetch(path, {
            method: 'PUT',
            body: text,
            headers: {
              Authorization: authorization,
              'Content-Type': contentType,
              'Content-Length': text.length
            }
          })
            .then(response => {
              if (response.status === 201) {
                console.log('File saved successfully')
              } else {
                throw new Error('Failed to save file')
              }
            })
            .catch(error => {
              console.error(error)
              alert('Error saving file')
            })
        }

        render() {
          const { userPublicKey, filename, contentType, path } = this.state
          return html`
            <div id="container">
              <h1>NosDAV</h1>
              <label for="file-name"
                >File${' '}
                <a href="#" id="download" target="_blank">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line></svg></a
              ></label>
              <input
                type="text"
                id="file-name"
                name="file-name"
                placeholder="Enter filename"
                value="${this.state.slug}"
                onInput="${event => {
                  this.updateSlug(event)
                  this.updateDownloadLink()
                }}"
              />
              <label for="content">Enter Text Below</label>

              <textarea
                id="file-content"
                placeholder="Login First"
                name="content"
                rows="10"
              ></textarea>
              <div>
                ${this.state.userPublicKey
                  ? html`
                      <button id="save" onClick="${this.save}">Save</button>
                      <button id="login" onClick="${this.userLogin}">
                        Load
                      </button>
                    `
                  : html` <button id="login" onClick="${this.userLogin}">
                      Login
                    </button>`}
              </div>
              <div></div>
            </div>
          `
        }
      }

      render(html` <${App} /> `, document.body)
    </script>
  </head>
  <body></body>
</html>
