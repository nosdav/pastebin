<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/style.css" />
    <title>NosDAV Pastebin</title>
    <script type="application/ld+json" id="data">
      {
        "@context": "https://schema.org"
      }
    </script>

    <script type="module">
      import { html, render, Component } from './js/spux.js'
      import './js/dior.js'

      const serverUrl =
        getQueryStringValue('storage') || 'https://nosdav.nostr.rocks'
      const mode = getQueryStringValue('mode') || 'm'
      var userPublicKey, filename, contentType, path
      var isJson = false

      function getPath(serverUrl, userPublicKey, filename, mode) {
        if (isAbsoluteUrl(filename)) {
          return filename
        }

        if (mode !== 'm') {
          return `${serverUrl}/${filename}`
        } else {
          return `${serverUrl}/${userPublicKey}/${filename}`
        }
      }

      function isAbsoluteUrl(url) {
        try {
          new URL(url)
          return true
        } catch (e) {
          return false
        }
      }

      function updateDownloadLink() {
        const inputSlug = document.getElementById('file-name').value
        const checkbox = document.getElementById('file-format')
        const downloadLink = document.getElementById('download')

        let filename

        filename = inputSlug

        const path = getPath(serverUrl, userPublicKey, filename, mode)
        downloadLink.setAttribute('href', path)
      }

      function getQueryStringValue(key) {
        const queryString = window.location.search.substring(1)
        const queryParams = new URLSearchParams(queryString)
        return queryParams.get(key)
      }

      async function generateAuthorizationHeader(pubkey) {
        const event = {
          kind: 27235,
          created_at: Math.floor(Date.now() / 1000),
          tags: [['url', path]],
          content: ''
        }
        const signedEvent = await window.nostr.signEvent(event)
        console.log(signedEvent)
        console.log(JSON.stringify(signedEvent))
        console.log(btoa(JSON.stringify(signedEvent)))

        return `Nostr ${btoa(JSON.stringify(signedEvent))}`
      }

      class App extends Component {
        constructor() {
          super()
          const slug = getQueryStringValue('slug') || 'paste.txt'
          this.state = {
            userPublicKey: null,
            filename: null,
            contentType: null,
            path: null,
            isJson: false,
            slug: slug
          }
          this.userLogin = this.userLogin.bind(this)
          this.save = this.save.bind(this)
          this.updateSlug = this.updateSlug.bind(this)
        }

        updateSlug(event) {
          this.setState({ slug: event.target.value })
        }

        async userLogin() {
          userPublicKey = await window.nostr.getPublicKey()
          console.log(`Logged in with public key: ${userPublicKey}`)
          this.setState({ userPublicKey: userPublicKey })
          this.loadFile()
        }

        // Load the file content from the server
        loadFile() {
          if (!userPublicKey) {
            alert('Please login first')
            return
          }

          var checkbox = document.getElementById('file-format')
          const fileContent = document.getElementById('file-content')
          const inputSlug = document.getElementById('file-name').value

          isJson = false
          filename = inputSlug

          path = getPath(serverUrl, userPublicKey, filename, mode)

          contentType = 'text/plain'
          document.getElementById('download').setAttribute('href', path)
          contentType = 'application/json'

          fetch(path, {
            headers: {
              Authorization: `Nostr ${userPublicKey}`
            }
          })
            .then(response => {
              if (response.status === 200) {
                return response.text()
              } else {
                throw new Error('Failed to load file content')
              }
            })
            .then(text => {
              fileContent.value = text
              fileContent.placeholder = ''
            })
            .catch(error => {
              console.error(error)
              fileContent.placeholder = 'Enter Text...'
            })

          updateDownloadLink()
        }

        async save() {
          if (!userPublicKey) {
            alert('Please login first')
            return
          }

          var checkbox = document.getElementById('file-format')
          const fileContent = document.getElementById('file-content')
          const inputSlug = document.getElementById('file-name').value

          isJson = false
          filename = inputSlug
          contentType = 'text/plain'

          const text = fileContent.value

          var authorization = await generateAuthorizationHeader(userPublicKey)

          let path = getPath(serverUrl, userPublicKey, filename, mode)

          fetch(path, {
            method: 'PUT',
            body: text,
            headers: {
              Authorization: authorization,
              'Content-Type': contentType,
              'Content-Length': text.length
            }
          })
            .then(response => {
              if (response.status === 201) {
                console.log('File saved successfully')
              } else {
                throw new Error('Failed to save file')
              }
            })
            .catch(error => {
              console.error(error)
              alert('Error saving file')
            })
        }

        render() {
          const { userPublicKey, filename, contentType, path, isJson } =
            this.state
          return html`
            <div id="container">
              <h1>NosDAV</h1>
              <label for="file-name"
                >File${' '}
                <a href="#" id="download" target="_blank">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line></svg></a
              ></label>
              <input
                type="text"
                id="file-name"
                name="file-name"
                placeholder="Enter filename"
                value="${this.state.slug}"
                onInput="${event => {
                  this.updateSlug(event)
                  updateDownloadLink()
                }}"
              />
              <label for="content">Enter Text Below</label>

              <textarea
                id="file-content"
                placeholder="Login First"
                name="content"
                rows="10"
              ></textarea>
              <div>
                ${this.state.userPublicKey
                  ? html`
                      <button id="save" onClick="${this.save}">Save</button>
                      <button id="login" onClick="${this.userLogin}">
                        Load
                      </button>
                    `
                  : html` <button id="login" onClick="${this.userLogin}">
                      Login
                    </button>`}
              </div>
              <div></div>
            </div>
          `
        }
      }

      render(html` <${App} /> `, document.body)
    </script>
  </head>
  <body></body>
</html>
